<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Do have faith in what you are doing."><title>Java WeakHashMap 源码解析 | Keep Writing Codes</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Java WeakHashMap 源码解析</h1><a id="logo" href="/.">Keep Writing Codes</a><p class="description">Lisp 追随者，SICP 受益者，持续分享编程心得</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/blogrolls/"><i class="fa fa-group"> 友情链接</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Java WeakHashMap 源码解析</h1><div class="post-meta">Sep 27, 2015<span> | </span><span class="category"><a href="/categories/PL/">编程语言</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a data-disqus-identifier="blog/2015/09/27/java-weakhashmap/" href="/blog/2015/09/27/java-weakhashmap/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#引用类型"><span class="toc-number">1.</span> <span class="toc-text">引用类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#强引用"><span class="toc-number">1.1.</span> <span class="toc-text">强引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#java-lang-ref-Reference"><span class="toc-number">1.2.</span> <span class="toc-text">java.lang.ref.Reference</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#构造函数"><span class="toc-number">1.2.1.</span> <span class="toc-text">构造函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#四种状态"><span class="toc-number">1.2.2.</span> <span class="toc-text">四种状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#get"><span class="toc-number">1.2.3.</span> <span class="toc-text">get</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#软引用（soft-reference）"><span class="toc-number">1.3.</span> <span class="toc-text">软引用（soft reference）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#弱引用（weak-reference）"><span class="toc-number">1.4.</span> <span class="toc-text">弱引用（weak reference）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#虚引用（phantom-reference）"><span class="toc-number">1.5.</span> <span class="toc-text">虚引用（phantom reference）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WeakHashMap-Entry"><span class="toc-number">2.</span> <span class="toc-text">WeakHashMap.Entry</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WeakHashMap-expungeStaleEntries"><span class="toc-number">3.</span> <span class="toc-text">WeakHashMap.expungeStaleEntries</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实战"><span class="toc-number">4.</span> <span class="toc-text">实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="post-content"><p>前面把基于特定数据结构的Map介绍完了，它们分别利用了相应数据结构的特点来实现特殊的目的，像HashMap利用哈希表的快速插入、查找实现<code>O(1)</code>的增删改查，TreeMap则利用了红黑树来保证key的有序性的同时，使得增删改查的时间复杂度为<code>O(log(n))</code>。</p>
<p>今天要介绍的<a href="http://docs.oracle.com/javase/7/docs/api/java/util/WeakHashMap.html" target="_blank" rel="external">WeakHashMap</a>并没有基于某种特殊的数据结构，它的主要目的是为了优化JVM，使JVM中的垃圾回收器（garbage collector，后面简写为 GC）更智能的回收“无用”的对象。</p>
<blockquote>
<p>本文源码分析基于<a href="http://www.oracle.com/technetwork/java/javase/7u71-relnotes-2296187.html" target="_blank" rel="external">Oracle JDK 1.7.0_71</a>，请知悉。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ java -version</div><div class="line">java version &quot;1.7.0_71&quot;</div><div class="line">Java(TM) SE Runtime Environment (build 1.7.0_71-b14)</div><div class="line">Java HotSpot(TM) 64-Bit Server VM (build 24.71-b01, mixed mode)</div></pre></td></tr></table></figure>
<h2 id="引用类型"><a href="#引用类型" class="headerlink" title="引用类型"></a>引用类型</h2><p><code>WeakHashMap</code>与其他 Map 最主要的不同之处在于其 key 是弱引用类型，其他 Map 的 key 均为强引用类型，说到这里，必须强调下：Java 中，引用有四种类型，分别为：强（strong）引用、软（soft）引用、弱（weak）引用、虚（phantom，本意为幽灵👻）引用。我相信对于 Java 初学者来说，不一定听过这几种引用类似，下面先介绍下这几种类型。</p>
<h3 id="强引用"><a href="#强引用" class="headerlink" title="强引用"></a>强引用</h3><p>这是最常用的引用类型，在执行下面的语句时，变量 <code>o</code> 即为一个强引用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Object o = new Object();</div></pre></td></tr></table></figure>
<blockquote>
<p>强引用指向的对象无论在何时，都不会被GC 清理掉。</p>
</blockquote>
<p>一般来说，对于常驻类应用（比如server），随着时间的增加，所占用的内存往往会持续上升，如果程序中全部使用强引用，那么很容易造成内存泄漏，最终导致<code>Out Of Memory (OOM)</code>，所以 Java 中提供了除强引用之外的其他三种引用，它们全部位于<code>java.lang.ref</code>包中，下面一一介绍。</p>
<h3 id="java-lang-ref-Reference"><a href="#java-lang-ref-Reference" class="headerlink" title="java.lang.ref.Reference"></a>java.lang.ref.Reference</h3><p><code>java.lang.ref.Reference</code> 为 软（soft）引用、弱（weak）引用、虚（phantom）引用的父类。</p>
<center><br>    <img src="https://img.alicdn.com/imgextra/i4/581166664/TB2FuyqfFXXXXcjXpXXXXXXXXXX_!!581166664.png" alt="Reference类继承关系"><br></center>

<p>下面分析下<code>Reference</code>的源码（其他三种引用都是其子类，区分不是很大）。</p>
<h4 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//referent 为引用指向的对象</span></div><div class="line">Reference(T referent) &#123;</div><div class="line">    <span class="keyword">this</span>(referent, <span class="keyword">null</span>);</div><div class="line">&#125;</div><div class="line"><span class="comment">//ReferenceQueue对象，可以简单理解为一个队列</span></div><div class="line"><span class="comment">//GC 在检测到appropriate reachability changes之后，</span></div><div class="line"><span class="comment">//会把引用对象本身添加到这个queue中，便于清理引用对象本身</span></div><div class="line">Reference(T referent, ReferenceQueue&lt;? <span class="keyword">super</span> T&gt; queue) &#123;</div><div class="line">    <span class="keyword">this</span>.referent = referent;</div><div class="line">    <span class="keyword">this</span>.queue = (queue == <span class="keyword">null</span>) ? ReferenceQueue.NULL : queue;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果我们在创建一个引用对象时，指定了<code>ReferenceQueue</code>，那么当引用对象指向的对象达到合适的状态（根据引用类型不同而不同）时，GC 会把引用对象本身添加到这个队列中，方便我们处理它，因为</p>
<blockquote>
<p>引用对象指向的对象 GC 会自动清理，但是引用对象本身也是对象（是对象就占用一定资源），所以需要我们自己清理。</p>
</blockquote>
<p>举个例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SoftReference&lt;String&gt; ss = new SoftReference&lt;String&gt;(&quot;abc&quot; , queue);</div></pre></td></tr></table></figure></p>
<p><code>ss</code> 为软引用，指向<code>abc</code>这个对象，<code>abc</code> 会在一定时机被 GC 自动清理，但是<code>ss</code>对象本身的清理工作依赖于<code>queue</code>，当<code>ss</code>出现在<code>queue</code>中时，说明其指向的对象已经无效，可以放心清理<code>ss</code>了。</p>
<p>从上面的分析大家应该对<code>Reference</code>类有了基本的认识，但是上面也提到了，不同的引用，添加到<code>ReferenceQueue</code>的时机是不一样。下面介绍具体引用时再进行说明。<br>这里有个问题，如果创建引用对象是没有指定<code>ReferenceQueue</code>，引用对象会怎么样呢？这里需要了解<code>Reference</code>类内部的四种状态。</p>
<h4 id="四种状态"><a href="#四种状态" class="headerlink" title="四种状态"></a>四种状态</h4><p>每一时刻，<code>Reference</code>对象都处于下面四种状态中。这四种状态用<code>Reference</code>的成员变量<code>queue</code>与<code>next</code>（类似于单链表中的next）来标示。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ReferenceQueue&lt;? super T&gt; queue;</div><div class="line">Reference next;</div></pre></td></tr></table></figure>
<ul>
<li><p>Active。新创建的引用对象都是这个状态，在 GC 检测到引用对象已经到达合适的reachability时，GC 会根据引用对象是否在创建时制定<code>ReferenceQueue</code>参数进行状态转移，如果指定了，那么转移到<code>Pending</code>，如果没指定，转移到<code>Inactive</code>。在这个状态中</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">//如果构造参数中没指定queue，那么queue为ReferenceQueue.NULL，否则为构造参数中传递过来的queue</div><div class="line">queue = ReferenceQueue || ReferenceQueue.NULL</div><div class="line">next = null</div></pre></td></tr></table></figure>
</li>
<li><p>Pending。pending-Reference列表中的引用都是这个状态，它们等着被内部线程<code>ReferenceHandler</code>处理（会调用<code>ReferenceQueue.enqueue</code>方法）。没有注册的实例不会进入这个状态。在这个状态中</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">//构造参数参数中传递过来的queue</div><div class="line">queue = ReferenceQueue</div><div class="line">next = 该queue中的下一个引用，如果是该队列中的最后一个，那么为this</div></pre></td></tr></table></figure>
</li>
<li><p>Enqueued。调用<code>ReferenceQueue.enqueued</code>方法后的引用处于这个状态中。没有注册的实例不会进入这个状态。在这个状态中</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">queue = ReferenceQueue.ENQUEUED</div><div class="line">next = 该queue中的下一个引用，如果是该队列中的最后一个，那么为this</div></pre></td></tr></table></figure>
</li>
<li><p>Inactive。最终状态，处于这个状态的引用对象，状态不会在改变。在这个状态中</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">queue = ReferenceQueue.NULL</div><div class="line">next = this</div></pre></td></tr></table></figure>
</li>
</ul>
<p>有了这些约束，GC 只需要检测<code>next</code>字段就可以知道是否需要对该引用对象采取特殊处理</p>
<ul>
<li>如果<code>next</code>为<code>null</code>，那么说明该引用为<code>Active</code>状态</li>
<li>如果<code>next</code>不为<code>null</code>，那么 GC 应该按其正常逻辑处理该引用。</li>
</ul>
<p>我自己根据<code>Reference.ReferenceHandler.run</code>与<code>ReferenceQueue.enqueue</code>这两个方法，画出了这四种状态的转移图，供大家参考：</p>
<center><br><img src="https://img.alicdn.com/imgextra/i2/581166664/TB2CCSNfFXXXXceXXXXXXXXXXXX_!!581166664.png" alt="Reference状态转移图"><br></center>

<p>要理解这个状态 GC 到底做了什么事，需要看 JVM 的代码，我这里时间、能力都不够，就不献丑了，后面有机会再来填坑。<br>对于一般程序员来说，这四种状态完全可以不用管。最后简单两句话总结上面的四种状态：</p>
<ol>
<li>如果构造函数中指定了<code>ReferenceQueue</code>，那么事后程序员可以通过该队列清理引用</li>
<li>如果构造函数中没有指定了<code>ReferenceQueue</code>，那么 GC 会自动清理引用</li>
</ol>
<h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><p>调用<code>Reference.get</code>方法可以得到该引用指向的对象，但是由于指向的对象随时可能被 GC 清理，所以即使在同一个线程中，不同时刻的调用可能返回不一样的值。</p>
<h3 id="软引用（soft-reference）"><a href="#软引用（soft-reference）" class="headerlink" title="软引用（soft reference）"></a>软引用（soft reference）</h3><p>软引用“保存”对象的能力稍逊于强引用，但是高于弱引用，一般用来实现memory-sensitive caches。</p>
<blockquote>
<p>软引用指向的对象会在程序即将触发<code>OOM</code>时被GC 清理掉，之后，引用对象会被放到<code>ReferenceQueue</code>中。</p>
</blockquote>
<h3 id="弱引用（weak-reference）"><a href="#弱引用（weak-reference）" class="headerlink" title="弱引用（weak reference）"></a>弱引用（weak reference）</h3><p>软引用“保存”对象的能力稍逊于弱引用，但是高于虚引用，一般用来实现canonicalizing mapping，也就是本文要讲的<code>WeakHashMap</code>😊。</p>
<blockquote>
<p>当弱引用指向的对象只能通过弱引用（没有强引用或弱引用）访问时，GC会清理掉该对象，之后，引用对象会被放到<code>ReferenceQueue</code>中。</p>
</blockquote>
<h3 id="虚引用（phantom-reference）"><a href="#虚引用（phantom-reference）" class="headerlink" title="虚引用（phantom reference）"></a>虚引用（phantom reference）</h3><p>虚引用是“保存”对象能力最弱的引用，一般用来实现scheduling pre-mortem cleanup actions in a more flexible way than is possible with the Java finalization mechanism</p>
<blockquote>
<p>调用虚引用的<code>get</code>方法，总会返回<code>null</code>，与软引用和弱引用不同的是，虚引用被<code>enqueued</code>时，GC 并不会自动清理虚引用指向的对象，只有当指向该对象的所有虚引用全部被清理（enqueued后）后或其本身不可达时，该对象才会被清理。</p>
</blockquote>
<h2 id="WeakHashMap-Entry"><a href="#WeakHashMap-Entry" class="headerlink" title="WeakHashMap.Entry"></a>WeakHashMap.Entry</h2><p>上面介绍了很多引用的知识点，其实<code>WeakHashMap</code>本身没什么好说的，只要是把引用的作用与使用场景搞清楚了，再来分析基于这些引用的对象就会很简单了。<br><code>WeakHashMap</code>与<code>HashMap</code>的签名与构造函数一样，这里就不介绍了，这里重点介绍下<code>Entry</code>这个内部对象，因为其保存具体key-value对，所以把它弄清楚了，其他的就问题不大了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * The entries in this hash table extend WeakReference, using its main ref</div><div class="line">  * field as the key.</div><div class="line">  */</div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">Object</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</div><div class="line">     V value;</div><div class="line">     <span class="keyword">int</span> hash;</div><div class="line">     Entry&lt;K,V&gt; next;</div><div class="line"></div><div class="line">     <span class="comment">/**</span></div><div class="line">      * Creates new entry.</div><div class="line">      */</div><div class="line">     Entry(Object key, V value,</div><div class="line">           ReferenceQueue&lt;Object&gt; queue,</div><div class="line">           <span class="keyword">int</span> hash, Entry&lt;K,V&gt; next) &#123;</div><div class="line">         <span class="comment">//这里把key传给了父类WeakReference，说明key为弱引用（没有显式的 this.key = key）</span></div><div class="line">         <span class="comment">//所有如果key只有通过弱引用访问时，key会被 GC 清理掉</span></div><div class="line">         <span class="comment">//同时该key所代表的Entry会进入queue中，等待被处理</span></div><div class="line">         <span class="comment">//还可以看到value为强引用（有显式的 this.value = value ），但这并不影响</span></div><div class="line">         <span class="comment">//后面可以看到WeakHashMap.expungeStaleEntries方法是如何清理value的</span></div><div class="line">         <span class="keyword">super</span>(key, queue);</div><div class="line">         <span class="keyword">this</span>.value = value;</div><div class="line">         <span class="keyword">this</span>.hash  = hash;</div><div class="line">         <span class="keyword">this</span>.next  = next;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">     <span class="comment">//在获取key时需要unmaskNull，因为对于null的key，是用WeakHashMap的内部成员属性来表示的</span></div><div class="line">     <span class="function"><span class="keyword">public</span> K <span class="title">getKey</span><span class="params">()</span> </span>&#123;</div><div class="line">         <span class="keyword">return</span> (K) WeakHashMap.unmaskNull(get());</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="function"><span class="keyword">public</span> V <span class="title">getValue</span><span class="params">()</span> </span>&#123;</div><div class="line">         <span class="keyword">return</span> value;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="function"><span class="keyword">public</span> V <span class="title">setValue</span><span class="params">(V newValue)</span> </span>&#123;</div><div class="line">         V oldValue = value;</div><div class="line">         value = newValue;</div><div class="line">         <span class="keyword">return</span> oldValue;</div><div class="line">     &#125;</div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</div><div class="line">         <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Map.Entry))</div><div class="line">             <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">         Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;)o;</div><div class="line">         K k1 = getKey();</div><div class="line">         Object k2 = e.getKey();</div><div class="line">         <span class="keyword">if</span> (k1 == k2 || (k1 != <span class="keyword">null</span> &amp;&amp; k1.equals(k2))) &#123;</div><div class="line">             V v1 = getValue();</div><div class="line">             Object v2 = e.getValue();</div><div class="line">             <span class="keyword">if</span> (v1 == v2 || (v1 != <span class="keyword">null</span> &amp;&amp; v1.equals(v2)))</div><div class="line">                 <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">         &#125;</div><div class="line">         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">         K k = getKey();</div><div class="line">         V v = getValue();</div><div class="line">         <span class="keyword">return</span> ((k==<span class="keyword">null</span> ? <span class="number">0</span> : k.hashCode()) ^</div><div class="line">                 (v==<span class="keyword">null</span> ? <span class="number">0</span> : v.hashCode()));</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">         <span class="keyword">return</span> getKey() + <span class="string">"="</span> + getValue();</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h2 id="WeakHashMap-expungeStaleEntries"><a href="#WeakHashMap-expungeStaleEntries" class="headerlink" title="WeakHashMap.expungeStaleEntries"></a>WeakHashMap.expungeStaleEntries</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Reference queue for cleared WeakEntries</div><div class="line"> */</div><div class="line"><span class="comment">// 所有Entry在构造时都传入该queue</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReferenceQueue&lt;Object&gt; queue = <span class="keyword">new</span> ReferenceQueue&lt;&gt;();</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Expunges stale entries from the table.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">expungeStaleEntries</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (Object x; (x = queue.poll()) != <span class="keyword">null</span>; ) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (queue) &#123;</div><div class="line">            <span class="comment">// e 为要清理的对象</span></div><div class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">                Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;) x;</div><div class="line">            <span class="keyword">int</span> i = indexFor(e.hash, table.length);</div><div class="line"></div><div class="line">            Entry&lt;K,V&gt; prev = table[i];</div><div class="line">            Entry&lt;K,V&gt; p = prev;</div><div class="line">            <span class="comment">// while 循环遍历冲突链</span></div><div class="line">            <span class="keyword">while</span> (p != <span class="keyword">null</span>) &#123;</div><div class="line">                Entry&lt;K,V&gt; next = p.next;</div><div class="line">                <span class="keyword">if</span> (p == e) &#123;</div><div class="line">                    <span class="keyword">if</span> (prev == e)</div><div class="line">                        table[i] = next;</div><div class="line">                    <span class="keyword">else</span></div><div class="line">                        prev.next = next;</div><div class="line">                    <span class="comment">// Must not null out e.next;</span></div><div class="line">                    <span class="comment">// stale entries may be in use by a HashIterator</span></div><div class="line">                    <span class="comment">// 可以看到这里把value赋值为null，来帮助 GC 回收强引用的value</span></div><div class="line">                    e.value = <span class="keyword">null</span>; <span class="comment">// Help GC</span></div><div class="line">                    size--;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                prev = p;</div><div class="line">                p = next;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>知道了<code>expungeStaleEntries</code>方法的作用，下面看看它是何时被调用的</p>
<center><br>    <img src="https://img.alicdn.com/imgextra/i4/581166664/TB2nMe3fFXXXXaFXXXXXXXXXXXX_!!581166664.png" alt="expungeStaleEntries调用链"><br></center>

<p>可以看到，在对<code>WeakHashMap</code>进行增删改查时，都调用了<code>expungeStaleEntries</code>方法。</p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>上面说了，下面来个具体的例子帮助大家消化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.WeakHashMap;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">KeyHolder</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        System.out.println(<span class="string">"I am over from key"</span>);</div><div class="line">        <span class="keyword">super</span>.finalize();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValueHolder</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        System.out.println(<span class="string">"I am over from value"</span>);</div><div class="line">        <span class="keyword">super</span>.finalize();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RefTest</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        WeakHashMap&lt;KeyHolder, ValueHolder&gt; weakMap = <span class="keyword">new</span> WeakHashMap&lt;KeyHolder, ValueHolder&gt;();</div><div class="line"></div><div class="line">        KeyHolder kh = <span class="keyword">new</span> KeyHolder();    </div><div class="line">        ValueHolder vh = <span class="keyword">new</span> ValueHolder();</div><div class="line"></div><div class="line">        weakMap.put(kh, vh);</div><div class="line"></div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (KeyHolder key : weakMap.keySet()) &#123;</div><div class="line">                System.out.println(key + <span class="string">" : "</span> + weakMap.get(key));</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                Thread.sleep(<span class="number">2000</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            System.out.println(<span class="string">"here..."</span>);</div><div class="line">            <span class="comment">//这里把kh设为null，这样一来就只有弱引用指向kh指向的对象</span></div><div class="line">            kh = <span class="keyword">null</span>;</div><div class="line">            System.gc();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">KeyHolder@a15670a : ValueHolder@20e1ed5b</div><div class="line">here...</div><div class="line">I am over from key   //输出这句话说明，该key对应的Entry已经被 GC 清理</div><div class="line">here...</div><div class="line">here...</div><div class="line">here...</div><div class="line">...</div><div class="line">...</div><div class="line">...</div></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>说实话，之前我是没怎么了解过引用，更是没有用过<code>WeakHashMap</code>这个类，这次算是把这个坑给填上了。引用的使用场景应该是在常驻类或消耗内存较大应用中才用得上，我自己确实没怎么经历过这种类型的项目，只能现在打好基础，以后有机会在尝试。</p>
<p>其实关于引用，本文重点介绍了弱引用的使用场景，其他的没怎么介绍，感兴趣的可以阅读参考中给出的链接。😊</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://weblogs.java.net/blog/2006/05/04/understanding-weak-references" target="_blank" rel="external">https://weblogs.java.net/blog/2006/05/04/understanding-weak-references</a></li>
<li><a href="http://www.onjava.com/pub/a/onjava/2001/07/09/optimization.html?page=1" target="_blank" rel="external">http://www.onjava.com/pub/a/onjava/2001/07/09/optimization.html?page=1</a></li>
<li><a href="http://stackoverflow.com/questions/5585694/whats-the-state-of-a-weak-reference-that-has-been-manually-enqueued" target="_blank" rel="external">whats-the-state-of-a-weak-reference-that-has-been-manually-enqueued</a></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://liujiacai.net/blog/2015/09/27/java-weakhashmap/" data-id="cjaf2hae8002lcoljqxr0b8zv" class="article-share-link">分享</a><div class="tags"><a href="/tags/java/">Java</a></div><div class="post-nav"><a href="/blog/2015/10/03/first-toy-scheme/" class="pre">我的第一个玩具语言 JCScheme 问世了</a><a href="/blog/2015/09/20/sicp-chapter2-summary/" class="next">SICP 第二章总结</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'jiacai2050';
var disqus_identifier = 'blog/2015/09/27/java-weakhashmap/';
var disqus_title = 'Java WeakHashMap 源码解析';
var disqus_url = 'http://liujiacai.net/blog/2015/09/27/java-weakhashmap/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/favicon.ico',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//jiacai2050.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://liujiacai.net"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata/">大数据</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/search-engine/">搜索引擎</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/life/">热爱生活</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/aha-computer/">理解计算机</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/研习经典/">研习经典</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PL/">编程语言</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/转载/">转载</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/regexp/" style="font-size: 15px;">regexp</a> <a href="/tags/music/" style="font-size: 15px;">music</a> <a href="/tags/java/" style="font-size: 15px;">Java</a> <a href="/tags/lucene/" style="font-size: 15px;">lucene</a> <a href="/tags/mooc/" style="font-size: 15px;">mooc</a> <a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/gcd/" style="font-size: 15px;">gcd</a> <a href="/tags/mozilla/" style="font-size: 15px;">mozilla</a> <a href="/tags/lambda/" style="font-size: 15px;">Lambda</a> <a href="/tags/lisp/" style="font-size: 15px;">Lisp</a> <a href="/tags/最佳实践/" style="font-size: 15px;">最佳实践</a> <a href="/tags/GEB/" style="font-size: 15px;">GEB</a> <a href="/tags/javascript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/sicp/" style="font-size: 15px;">sicp</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/scheme/" style="font-size: 15px;">Scheme</a> <a href="/tags/string/" style="font-size: 15px;">string</a> <a href="/tags/python/" style="font-size: 15px;">Python</a> <a href="/tags/ruby/" style="font-size: 15px;">Ruby</a> <a href="/tags/马拉松/" style="font-size: 15px;">马拉松</a> <a href="/tags/千里路/" style="font-size: 15px;">千里路</a> <a href="/tags/Clojure/" style="font-size: 15px;">Clojure</a> <a href="/tags/ideas/" style="font-size: 15px;">ideas</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/blog/2017/11/22/create-firefox-chrome-extensions-in-clojurescript/">使用 ClojureScript 开发浏览器插件</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2017/10/01/macro-in-action/">由浅入深学习 Lisp 宏之实战篇</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2017/08/31/master-macro-understand-symbol/">由浅入深学习 Lisp 宏之理论篇</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2017/05/11/review-of-secret-of-silicon-valley/">《硅谷之谜》读后感</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2017/04/02/clojure-web-dev-ring-usage/">Clojure Web 开发-- Ring 使用指南</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2017/03/22/ace-technical-interview/">“玩转” 技术面试——链表的函数表示法</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2017/03/05/method-vs-proc-in-ruby/">辨析 Ruby 中的 Method 与 Proc</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2017/02/09/clojure-compiler-analyze-2/">Clojure 运行原理之字节码生成篇</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2017/02/05/clojure-compiler-analyze/">Clojure 运行原理之编译器剖析篇</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2017/01/08/review-2016/">2016 年终总结</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//jiacai2050.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">Keep Writing Codes.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3ffc15f400ce3f8b1db5afc4f29b6ce9";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>