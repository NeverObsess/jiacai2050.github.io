<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Do have faith in what you are doing."><title>使用 ClojureScript 开发浏览器插件的过程与收获 | Keep Writing Codes</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">使用 ClojureScript 开发浏览器插件的过程与收获</h1><a id="logo" href="/.">Keep Writing Codes</a><p class="description">Lisp 追随者，SICP 受益者，持续分享编程心得</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/blogrolls/"><i class="fa fa-group"> 友情链接</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">使用 ClojureScript 开发浏览器插件的过程与收获</h1><div class="post-meta">Nov 22, 2017<span> | </span><span class="category"><a href="/categories/PL/">编程语言</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a data-disqus-identifier="blog/2017/11/22/create-firefox-chrome-extensions-in-clojurescript/" href="/blog/2017/11/22/create-firefox-chrome-extensions-in-clojurescript/#disqus_thread" class="disqus-comment-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ClojureScript-工作机制"><span class="toc-number">1.</span> <span class="toc-text">ClojureScript 工作机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开发环境准备"><span class="toc-number">2.</span> <span class="toc-text">开发环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#消除-inline-script"><span class="toc-number">2.1.</span> <span class="toc-text">消除 inline script</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#区分-dev-与-release-模式"><span class="toc-number">2.2.</span> <span class="toc-text">区分 dev 与 release 模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#externs"><span class="toc-number">2.3.</span> <span class="toc-text">externs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试环境"><span class="toc-number">2.4.</span> <span class="toc-text">测试环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#re-agent"><span class="toc-number">2.5.</span> <span class="toc-text">re-agent</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#坑"><span class="toc-number">3.</span> <span class="toc-text">坑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#宏"><span class="toc-number">3.1.</span> <span class="toc-text">宏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IDE"><span class="toc-number">3.2.</span> <span class="toc-text">IDE</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="post-content"><p>随着 Firefox 57 的到来，之前维护的一个浏览器插件 <a href="https://github.com/jiacai2050/gooreplacer" target="_blank" rel="external">gooreplacer</a> 必须升级到 WebExtensions 才能继续使用，看了下之前写的 JS 代码，毫无修改的冲动，怕改了这个地方，那个地方突然就 broken 了。因此，这次选择了 cljs，整体下来流程很顺利，除了迁移之前的功能，又加了更多功能，希望能成为最简单易用的重定向插件 :-)</p>
<p>闲话少说，下面的内容依次会介绍 cljs 的工作机制、开发环境，如何让 cljs 适配浏览器插件规范，以及重写 gooreplacer 时的一些经验。<br>本文的读者需要对 Clojure 语言、浏览器插件开发一般流程有基本了解，并且完成 ClojureScript 的 <a href="https://clojurescript.org/guides/quick-start" target="_blank" rel="external">Quick Start</a>。对于 Clojure，我目前在 sf 上有<a href="https://github.com/jiacai2050/learn_clojure.mp4" target="_blank" rel="external">一套视频课程</a>，供参考。</p>
<p>为了方便大家使用 cljs 开发插件，我整理了<a href="https://github.com/jiacai2050/browser-extenstion.cljs" target="_blank" rel="external">一份模板</a>，供大家参考。gooreplacer 完整代码在<a href="https://github.com/jiacai2050/gooreplacer" target="_blank" rel="external">这里</a>，技术栈为  ClojureScript + Reagent + Antd + React-Bootstrap。</p>
<h2 id="ClojureScript-工作机制"><a href="#ClojureScript-工作机制" class="headerlink" title="ClojureScript 工作机制"></a>ClojureScript 工作机制</h2><p>ClojureScript 是使用 Clojure 编写，最终编译生成 JS 代码的一个<a href="http://blog.fogus.me/2012/04/25/the-clojurescript-compilation-pipeline/" target="_blank" rel="external">编译器</a>，在编译过程中使用 <a href="https://github.com/google/closure-compiler" target="_blank" rel="external">Google Closure Compiler</a> 来优化 JS 代码、解决<a href="https://github.com/google/closure-compiler/wiki/Managing-Dependencies" target="_blank" rel="external">模块化引用</a>的问题。整体工作流程如下：</p>
<p><img src="/images/clojure/cljs_compile.png" alt="cljs 编译流程"></p>
<p>Cljs 还提供 <a href="http://cljs.info/cheatsheet/" target="_blank" rel="external">与原生 JS 的交互</a>、<a href="https://clojurescript.org/reference/javascript-module-support" target="_blank" rel="external">集成</a><a href="https://clojurescript.org/news/2017-07-12-clojurescript-is-not-an-island-integrating-node-modules" target="_blank" rel="external">第三方类库</a>的支持，所以，只要能用 JS 的地方，都能用 cljs，</p>
<h2 id="开发环境准备"><a href="#开发环境准备" class="headerlink" title="开发环境准备"></a>开发环境准备</h2><p>开发 cljs 的环境首选 <a href="https://github.com/technomancy/leiningen#installation" target="_blank" rel="external">lein</a> + <a href="https://github.com/bhauman/lein-figwheel" target="_blank" rel="external">figwheel</a>，figwheel 相比 <a href="https://github.com/emezeske/lein-cljsbuild" target="_blank" rel="external">lein-cljsbuild</a> 提供了热加载的功能，这一点对于开发 UI 很重要！</p>
<p>对于一般的 cljs 应用，基本都是用一个 script 标签去引用编译后的 js 文件，然后这个 js 文件再去加载其他依赖。比如：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"js/main.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>js/main.js 是 project.clj 里面指定的输出文件，它会去加载其他所需文件，其内容大致如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> CLOSURE_UNCOMPILED_DEFINES = &#123;&#125;;</div><div class="line"><span class="keyword">var</span> CLOSURE_NO_DEPS = <span class="literal">true</span>;</div><div class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span> goog == <span class="string">"undefined"</span>) <span class="built_in">document</span>.write(<span class="string">'&lt;script src="js/out/goog/base.js"&gt;&lt;/script&gt;'</span>);</div><div class="line"><span class="built_in">document</span>.write(<span class="string">'&lt;script src="js/out/goog/deps.js"&gt;&lt;/script&gt;'</span>);</div><div class="line"><span class="built_in">document</span>.write(<span class="string">'&lt;script src="js/out/cljs_deps.js"&gt;&lt;/script&gt;'</span>);</div><div class="line"><span class="built_in">document</span>.write(<span class="string">'&lt;script&gt;if (typeof goog == "undefined") console.warn("ClojureScript could not load :main, did you forget to specify :asset-path?");&lt;/script&gt;'</span>);</div><div class="line"><span class="built_in">document</span>.write(<span class="string">'&lt;script&gt;goog.require("process.env");&lt;/script&gt;'</span>);</div><div class="line"></div><div class="line"><span class="built_in">document</span>.write(<span class="string">"&lt;script&gt;if (typeof goog != \"undefined\") &#123; goog.require(\"figwheel.connect.build_dev\"); &#125;&lt;/script&gt;"</span>);</div><div class="line"><span class="built_in">document</span>.write(<span class="string">'&lt;script&gt;goog.require("hello_world.core");&lt;/script&gt;'</span>);</div></pre></td></tr></table></figure>
<h3 id="消除-inline-script"><a href="#消除-inline-script" class="headerlink" title="消除 inline script"></a>消除 inline script</h3><p>对于一般的 Web 项目，只引用这一个 js 文件就够了，但是对于浏览器插件来说，有一些问题，浏览器插件出于安全因素考虑，是<a href="https://developer.chrome.com/extensions/contentSecurityPolicy#relaxing-inline-script" target="_blank" rel="external">不让执行 incline script</a>，会报如下错误</p>
<p><img src="https://img.alicdn.com/imgextra/i1/581166664/TB2xXZVeJnJ8KJjSszdXXaxuFXa_!!581166664.png" alt="inline script error"></p>
<p>为了去掉这些错误，手动加载 js/main.js 里面动态引入的文件，require 所需命名空间即可，修改后的 html 如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/out/goog/base.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/out/cljs_deps.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/init.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<p>其中 init.js 内容为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// figwheel 用于热加载，这里的 build_dev 其实是 build_&#123;build_id&#125;，默认是 dev</span></div><div class="line">goog.require(<span class="string">"figwheel.connect.build_dev"</span>);</div><div class="line"><span class="comment">// 加载为 main 的命名空间</span></div><div class="line">goog.require(<span class="string">"hello_world.core"</span>);</div></pre></td></tr></table></figure>
<p>这样就可以正常在浏览器插件环境中运行了。可以在 DevTools 中观察到所有引用的 js 文件</p>
<p><img src="https://img.alicdn.com/imgextra/i2/581166664/TB2buKhe3vD8KJjSsplXXaIEFXa_!!581166664.png" alt="动态加载的 JS 文件"> </p>
<p>在左下角可以看到，总共有 92 个文件。</p>
<p>对于 background page/option page/popup page 这三处都可采用这种措施，但是 content script 没法指定 js 脚本加载顺序，可以想到的一种方式是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&quot;content_scripts&quot;: [&#123;</div><div class="line">  &quot;matches&quot;: [&quot;http://*/*&quot;, &quot;https://*/*&quot;],</div><div class="line">  &quot;run_at&quot;: &quot;document_end&quot;,</div><div class="line">  &quot;js&quot;: [&quot;content/js/out/goog/base.js&quot;, &quot;content/js/out/cljs_deps.js&quot;, &quot;content/init.js&quot;]</div><div class="line">&#125;]</div></pre></td></tr></table></figure>
<p>这里的 content 的目录与 manifest.json 在同一级目录。采用这种方式会报如下的错误</p>
<p><img src="https://img.alicdn.com/imgextra/i2/581166664/TB2vEaHbBLN8KJjSZPhXXc.spXa_!!581166664.png" alt="content script 报错"></p>
<p>根据错误提示，可以看出是 base.js 再去动态引用其他 js 文件时，是以访问网站为相对路径开始的，因此也就找不到正确的 JS 文件了。</p>
<p>解决方法是设置 cljsbuild 的 <code>optimizations</code> 为 <code>:whitespace</code>，把所有文件打包到一个文件，然后引用这一个就可以了，<a href="https://github.com/binaryage/chromex-sample/issues/2" target="_blank" rel="external">这个方法不是很完美</a>，采用 whitespace 一方面使编译时间更长，在我机器上需要12s；另一方面是无法使用 figwheel，会报 A Figwheel build must have :compiler &gt; :optimizations default to nil or set to :none 的错误，因此也就无法使用代码热加载的功能。</p>
<p>gooreplacer 里面只使用了 background page 与 option page，所以这个问题也就避免了。</p>
<h3 id="区分-dev-与-release-模式"><a href="#区分-dev-与-release-模式" class="headerlink" title="区分 dev 与 release 模式"></a>区分 dev 与 release 模式</h3><p>这里的 dev 是指正常的开发流程，release 是指开发完成，准备打包上传到应用商店的过程。</p>
<p>在 dev 过程中，推荐设置 cljsbuild 的 <code>optimizations</code> 为 none，以便得到最快的编译速度；<br>在 release 过程中，可以将其设置为 <code>advanced</code>，来压缩、优化 js 文件，以便最终的体积最小。</p>
<p>为了在两种模式中复用使用的图片、css 等资源，可采用了软链的来实现，resources 目录结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">.</div><div class="line">├── css</div><div class="line">│   └── option.css</div><div class="line">├── dev</div><div class="line">│   ├── background</div><div class="line">│   │   ├── index.html</div><div class="line">│   │   └── init.js</div><div class="line">│   ├── content</div><div class="line">│   ├── manifest.json -&gt; ../manifest.json</div><div class="line">│   └── option</div><div class="line">│       ├── css -&gt; ../../css/</div><div class="line">│       ├── images -&gt; ../../images/</div><div class="line">│       ├── index.html</div><div class="line">│       └── init.js</div><div class="line">├── images</div><div class="line">│   ├── cljs.png</div><div class="line">│   ├── cljs_16.png</div><div class="line">│   ├── cljs_32.png</div><div class="line">│   └── cljs_48.png</div><div class="line">├── manifest.json</div><div class="line">└── release</div><div class="line">    ├── background</div><div class="line">    │   ├── index.html</div><div class="line">    │   └── js</div><div class="line">    │       └── main.js</div><div class="line">    ├── content</div><div class="line">    │   └── js</div><div class="line">    │       └── main.js</div><div class="line">    ├── manifest.json -&gt; ../manifest.json</div><div class="line">    └── option</div><div class="line">        ├── css -&gt; ../../css/</div><div class="line">        ├── images -&gt; ../../images/</div><div class="line">        ├── index.html</div><div class="line">        └── js</div><div class="line">            └── main.js</div></pre></td></tr></table></figure>
<p>其次，为了方便开启多个 figwheel 实例来分别编译 background、option 里面的 js，定义了多个 lein 的 profiles，来指定不同环境下的配置，具体可参考 <a href="https://github.com/jiacai2050/browser-extenstion.cljs/blob/master/project.clj#L13" target="_blank" rel="external">模板的 project.clj</a> 文件。</p>
<h3 id="externs"><a href="#externs" class="headerlink" title="externs"></a>externs</h3><p>在 optimizations 为 advanced 时，cljs 会充分借用 Google Closure Compiler 来压缩、混淆代码，会把变量名重命名为 a b c 之类的简写，为了不使 chrome/firefox 插件 API 里面的函数混淆，需要加载它们对应的 externs 文件，一般只需要这两个 <a href="https://github.com/google/closure-compiler/blob/master/contrib/externs/chrome_extensions.js" target="_blank" rel="external">chrome_extensions.js</a>、<a href="https://github.com/google/closure-compiler/blob/master/contrib/externs/chrome.js" target="_blank" rel="external">chrome.js</a>。</p>
<h3 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h3><p>cljs 自带的 test 功能比较搓，比较好用的是 <a href="https://github.com/bensu/doo" target="_blank" rel="external">doo</a>，为了使用它，需要先提前安装 <a href="http://phantomjs.org/" target="_blank" rel="external">phantom</a> 来提供 headless 环境，写好测试就可以执行了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lein doo phantom &#123;build-id&#125; &#123;watch-mode&#125;</div></pre></td></tr></table></figure>
<p>非常棒的一点是它也能支持热加载，所以在开发过程中我一直开着它。</p>
<h3 id="re-agent"><a href="#re-agent" class="headerlink" title="re-agent"></a>re-agent</h3><p><a href="http://reagent-project.github.io/" target="_blank" rel="external">re-agent</a> 是对 React 的一个封装，使之符合 cljs 开发习惯。毫无夸张的说，对于非专业前端程序员来说，要想使用 React，cljs 比 jsx 是个更好的选择，<a href="https://github.com/weavejester/hiccup" target="_blank" rel="external">Hiccup-like</a> 的语法比 jsx 更紧凑，不用再去理睬 <a href="https://webpack.js.org/" target="_blank" rel="external">webpack</a>，<a href="https://babeljs.io/" target="_blank" rel="external">babel</a> 等等层出不穷的 js 工具，更重要的一点是 immutable 在 cljs 中无处不在，re-agent 里面有自己维护状态的机制 atom，不在需要严格区分 React 里面的 props 与 state。</p>
<p>了解 re-agent 的最好方式就是从它<a href="http://reagent-project.github.io/" target="_blank" rel="external">官网给出的示例</a>开始，然后阅读 re-frame wiki 里面的 <a href="https://github.com/Day8/re-frame/wiki/Creating-Reagent-Components" target="_blank" rel="external">Creating Reagent Components</a>，了解三种不同的 form 的区别，98% gooreplacer 都在使用 form-2。如果对原理感兴趣，建议也把其他 wiki 看完。</p>
<p>re-agent 还有一点比较实用，提供了对 React 原生组件的转化函数：<a href="http://nicolovaligi.com/boostrap-components-reagent-clojurescript.html" target="_blank" rel="external">adapt-react-class</a>，使用非常简单：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(def Button (reagent/adapt-react-class (aget js/ReactBootstrap &quot;Button&quot;)))</div><div class="line"></div><div class="line">[:div</div><div class="line">  [:h2 &quot;A sample title&quot;]</div><div class="line">  [Button &quot;with a button&quot;]]</div></pre></td></tr></table></figure>
<p>这样就不用担心 React 的类库不能在 cljs 中使用的问题了。</p>
<p>说到 re-agent，就不能不提到 <a href="https://github.com/omcljs/om/wiki/Quick-Start-%28om.next%29" target="_blank" rel="external">om.next</a>，这两个在 cljs 社区里面应该是最有名的 React wrapper，om.next 理念与使用难度均远高于 re-agent，初学者一般不推荐直接用 om.next。感兴趣的可以看看这两者之间的比较：</p>
<ul>
<li><a href="https://purelyfunctional.tv/article/why-re-frame-instead-of-om-next/" target="_blank" rel="external">Why Re-frame instead of Om Next</a>，以及 <a href="https://www.reddit.com/r/Clojure/comments/6q0jhn/why_reframe_instead_of_om_next/" target="_blank" rel="external">Reddit 上的讨论</a></li>
<li><a href="https://www.reddit.com/r/Clojure/comments/3vk58p/a_rant_on_om_next/" target="_blank" rel="external">A rant on Om Next</a></li>
</ul>
<h2 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h2><h3 id="宏"><a href="#宏" class="headerlink" title="宏"></a><a href="https://clojurescript.org/about/differences#_macros" target="_blank" rel="external">宏</a></h3><p>cljs 里面加载宏的机制有别于 Clojure，一般需要单独把宏定义在一个文件里面，然后在 cljs 里面用<code>(:require-macros [my.macros :as my])</code> 这样的方式去引用，而且宏定义的文件名后缀必须是 clj 或 cljc，不能是 cljs，这一点坑了我好久。。。</p>
<p>由于宏编译与 cljs 编程在不同的时期，所以如果宏写错了，就需要把 repl 杀掉重启来把新的宏 feed 给 cljs，这点也比较痛苦，因为 repl 的启动速度实在是有些慢。这一点在 Clojure 里面虽然也存在，但是 Clojure 里面一般 repl 开了就不关了，直到电脑重启。</p>
<p><img src="https://img.alicdn.com/imgextra/i1/581166664/TB2iGyXbvjM8KJjSZFyXXXdzVXa_!!581166664.png" alt="我机器上启动的 repl 列表"></p>
<h3 id="IDE"><a href="#IDE" class="headerlink" title="IDE"></a>IDE</h3><p>Clojure 里面采用 Emacs + Cider 的开发环境非常完美，但是到了 cljs 里面，开发流程没有那么平滑，总是有些磕磕绊绊，也给 cider <a href="https://github.com/clojure-emacs/cider/issues/2099" target="_blank" rel="external">提了个 issue</a>，貌似一直没人理，支持确实不好，不过有了 figwheel，在一定程度上能弥补这个缺陷。在 Emacs 里面配置 repl 可参考：</p>
<ul>
<li><a href="https://cider.readthedocs.io/en/latest/up_and_running/#clojurescript-usage" target="_blank" rel="external">https://cider.readthedocs.io/en/latest/up_and_running/#clojurescript-usage</a></li>
</ul>
<p>Cider 默认会使用 rhino 作为 repl 求值环境，这个在开发浏览器插件时功能很有限，但是对于查看函数定义还是可以的。可以根据需要换成 figwheel。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>ClojureScript 可以算是 Clojure 语言的一个<a href="https://www.reddit.com/r/Clojure/comments/75apb2/does_clojure_have_a_killer_app/" target="_blank" rel="external">杀手级</a><a href="https://groups.google.com/forum/#!topic/clojure/YCnG3rmOp5w" target="_blank" rel="external">应用</a>，React 使得后端程序员也能快速作出美观实用的界面。ClojureScript + React，用起来不能再开心啦！</p>
<p>JS 社区里面层出不穷的框架每次都让跃跃欲试的我望而却步，有了 cljs，算是把 Lisp 延伸到了更宽广的“领土”。最近看到这么一句话，与大家分享：</p>
<blockquote>
<p>也许 Lisp 不是解决所有问题最合适的语言，但是它鼓励你设计一种最合适的语言来解决这个难题。</p>
</blockquote>
<p>出处忘记了，大体是这么个意思。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://nvbn.github.io/2014/12/07/chrome-extension-clojurescript/" target="_blank" rel="external">Chrome extension in ClojureScript</a></li>
<li><a href="https://github.com/binaryage/chromex-sample" target="_blank" rel="external">https://github.com/binaryage/chromex-sample</a></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://liujiacai.net/blog/2017/11/22/create-firefox-chrome-extensions-in-clojurescript/" data-id="cjbj26h5o004w85lj3r818dvn" class="article-share-link">分享</a><div class="tags"><a href="/tags/Clojure/">Clojure</a></div><div class="post-nav"><a href="/blog/2017/10/01/macro-in-action/" class="next">由浅入深学习 Lisp 宏之实战篇</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'jiacai2050';
var disqus_identifier = 'blog/2017/11/22/create-firefox-chrome-extensions-in-clojurescript/';
var disqus_title = '使用 ClojureScript 开发浏览器插件的过程与收获';
var disqus_url = 'http://liujiacai.net/blog/2017/11/22/create-firefox-chrome-extensions-in-clojurescript/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/favicon.ico',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//jiacai2050.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://liujiacai.net"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata/">大数据</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/search-engine/">搜索引擎</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/life/">热爱生活</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/aha-computer/">理解计算机</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/研习经典/">研习经典</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PL/">编程语言</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/转载/">转载</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/regexp/" style="font-size: 15px;">regexp</a> <a href="/tags/java/" style="font-size: 15px;">Java</a> <a href="/tags/mooc/" style="font-size: 15px;">mooc</a> <a href="/tags/music/" style="font-size: 15px;">music</a> <a href="/tags/GEB/" style="font-size: 15px;">GEB</a> <a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/gcd/" style="font-size: 15px;">gcd</a> <a href="/tags/mozilla/" style="font-size: 15px;">mozilla</a> <a href="/tags/最佳实践/" style="font-size: 15px;">最佳实践</a> <a href="/tags/lambda/" style="font-size: 15px;">Lambda</a> <a href="/tags/lisp/" style="font-size: 15px;">Lisp</a> <a href="/tags/lucene/" style="font-size: 15px;">lucene</a> <a href="/tags/javascript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/sicp/" style="font-size: 15px;">sicp</a> <a href="/tags/scheme/" style="font-size: 15px;">Scheme</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/string/" style="font-size: 15px;">string</a> <a href="/tags/python/" style="font-size: 15px;">Python</a> <a href="/tags/ruby/" style="font-size: 15px;">Ruby</a> <a href="/tags/马拉松/" style="font-size: 15px;">马拉松</a> <a href="/tags/千里路/" style="font-size: 15px;">千里路</a> <a href="/tags/Clojure/" style="font-size: 15px;">Clojure</a> <a href="/tags/ideas/" style="font-size: 15px;">ideas</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/blog/2017/11/22/create-firefox-chrome-extensions-in-clojurescript/">使用 ClojureScript 开发浏览器插件的过程与收获</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2017/10/01/macro-in-action/">由浅入深学习 Lisp 宏之实战篇</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2017/08/31/master-macro-theory/">由浅入深学习 Lisp 宏之理论篇</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2017/05/11/review-of-secret-of-silicon-valley/">《硅谷之谜》读后感</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2017/04/02/clojure-web-dev-ring-usage/">Clojure Web 开发-- Ring 使用指南</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2017/03/22/ace-technical-interview/">“玩转” 技术面试——链表的函数表示法</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2017/03/05/method-vs-proc-in-ruby/">辨析 Ruby 中的 Method 与 Proc</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2017/02/09/clojure-compiler-analyze-2/">Clojure 运行原理之字节码生成篇</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2017/02/05/clojure-compiler-analyze/">Clojure 运行原理之编译器剖析篇</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2017/01/08/review-2016/">2016 年终总结</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//jiacai2050.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">Keep Writing Codes.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3ffc15f400ce3f8b1db5afc4f29b6ce9";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>